# Generated by Django 2.2.24 on 2021-09-07 14:03

from django.db import migrations, models
import django.db.models.deletion

def drop_related_sectors_and_subsector_data(apps, schema_editor):
    # Before this migration InvestmentOpportunityRelatedSectors were pointing to the old
    # sector and sub-sector models, so running this migration with existing data caused a blow-up
    # because of missing FKs. However, because this is all new data, we can dispose of it
    # and it will be set up manually for the new relationships instead. 

    InvestmentOpportunityPage = apps.get_model(
        'great_international', 
        'InvestmentOpportunityPage',
    )
    InternationalSectorPage = apps.get_model(
        'great_international', 
        'InternationalSectorPage',
    )
    InternationalSubSectorPage = apps.get_model(
        'great_international', 
        'InternationalSubSectorPage',
    )
    InternationalInvestmentSectorPage = apps.get_model(
        'great_international', 
        'InternationalInvestmentSectorPage',
    )
    InternationalInvestmentSubSectorPage = apps.get_model(
        'great_international', 
        'InternationalInvestmentSubSectorPage',
    )

    # These models we want to drop data for
    InvestmentOpportunityRelatedSectors = apps.get_model(
        'great_international', 
        'InvestmentOpportunityRelatedSectors',
    )
    InvestmentOpportunityRelatedSubSectors = apps.get_model(
        'great_international', 
        'InvestmentOpportunityRelatedSubSectors',
    )

    # Get stats on pages we want to retain
    initial_io_page_count = InvestmentOpportunityPage.objects.all().count()
    initial_existing_sector_page_count = InternationalSectorPage.objects.all().count()
    initial_existing_sub_sector_page_count = InternationalSubSectorPage.objects.all().count()
    initial_new_sector_page_count = InternationalInvestmentSectorPage.objects.all().count()
    initial_new_sub_sector_page_count = InternationalInvestmentSubSectorPage.objects.all().count()

    # The actal work
    InvestmentOpportunityRelatedSubSectors.objects.all().delete()
    InvestmentOpportunityRelatedSectors.objects.all().delete()

    # The checks
    if initial_io_page_count != InvestmentOpportunityPage.objects.all().count():
        raise Exception("DID NOT EXPECT InvestmentOpportunityPage PAGES TO BE DELETED")

    if initial_existing_sector_page_count != InternationalSectorPage.objects.all().count():
        raise Exception("DID NOT EXPECT InternationalSectorPage PAGES TO BE DELETED")

    if initial_existing_sub_sector_page_count != InternationalSubSectorPage.objects.all().count():
        raise Exception("DID NOT EXPECT InternationalSubSectorPage PAGES TO BE DELETED")

    if initial_new_sector_page_count != InternationalInvestmentSectorPage.objects.all().count():
        raise Exception("DID NOT EXPECT InternationalInvestmentSectorPage PAGES TO BE DELETED!")

    if initial_new_sub_sector_page_count != InternationalInvestmentSubSectorPage.objects.all().count():
        raise Exception("DID NOT EXPECT InternationalInvestmentSubSectorPage PAGES TO BE DELETED!")


class Migration(migrations.Migration):

    dependencies = [
        ('great_international', '0105_refactor_manually_selected_related_opportunities'),
    ]
    
    operations = [
        migrations.RunPython(
            drop_related_sectors_and_subsector_data,
            reverse_code=migrations.RunPython.noop,
            elidable=True
        ),
        migrations.AlterField(
            model_name='investmentopportunityrelatedsectors',
            name='related_sector',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to='great_international.InternationalInvestmentSectorPage'),
        ),
        migrations.AlterField(
            model_name='investmentopportunityrelatedsubsectors',
            name='related_sub_sector',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to='great_international.InternationalInvestmentSubSectorPage'),
        ),
    ]
